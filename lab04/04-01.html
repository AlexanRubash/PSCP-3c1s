<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Event Emitter</title>
</head>
<body>
<div id="select_result"></div>

<button onclick="select()">Получить данные</button>

<br/>
<div class="stripes-block">
    <div class="form-group">
        <div class='row'>
            <label for="ID">ID</label>
            <input type="number" id="ID" min="0"/>
        </div>
        <div class='row'>
            <label for="Name">Имя</label>
            <input type="text" id="Name"/>
        </div>
        <div class='row'>
            <label for="Bday">День рождения</label>
            <input type="date" id="Bday" />
    </div>
</div>

    <div class='row'>
        <button onclick="insert()">Добавить</button>
    </div>
    <div class='row'>
        <button onclick="update()">Обновить</button>
    </div>
    <div class='row'>
        <button onclick="remove()">Удалить</button>
    </div>
    <h2 id="Errors" style="color: red;"></h2>
</div>

<script>

    Errors.innerHTML = "";

    document.getElementById("ID").addEventListener('change',async (e)=> {
        let array = await fetch("/api/db", {method: "GET", headers: {'Accept': 'application/json'} })   ;
        array = await array.json();
        if(e.target.value === "")
        {
            document.getElementById("Name").value = "";
            document.getElementById("Bday").value = "";
        }
        else {
            document.getElementById("Name").value = array[e.target.value - 1].name;
            let bday = array[e.target.value - 1].bday;
            let parts = bday.split('-');
            let formattedBday = parts[2] + '-' + parts[1] + '-' + parts[0];
            document.getElementById("Bday").value = formattedBday;
            console.log(array[e.target.value -1]);
        }
    })
    const select = () => {
        Errors.innerHTML = "";
        fetch("/api/db", {method: "GET", headers: {'Accept': 'application/json'}, mode: "no-cors"})
            .then(response => response.json())
            .then(data => {
                select_result.innerHTML = "";
                data.forEach(el => select_result.innerHTML += `${el.id}. ${el.name} - ${el.bday}<br>`);
            }).catch((error) => error.innerHTML += error.error)
    }
    const insert = () => {
        Errors.innerHTML = "";
        fetch("/api/db", {
            method: "POST",
            headers: {'Accept': 'application/json', 'Content-Type': 'application/json',},
            mode: "no-cors",
            body: JSON.stringify({
                id: ID.value,
                name: Name.value,
                bday: Bday.value,
            })
        })
            .then(async response => {
                if (!response.ok) {
                    let a = await response.json();
                    Errors.innerHTML = a.error;
                    }
                else
                    return  response.json();
            })
            .then(data => {
                ID.value = "";
                Name.value = "";
                Bday.value = "";
            })
    }

    const update = () => {
        Errors.innerHTML = "";
        fetch("/api/db", {
            method: "PUT",
            headers: {'Accept': 'application/json', 'Content-Type': 'application/json',},
            body: JSON.stringify({
                id: ID.value,
                name: Name.value,
                bday: Bday.value,
            })
        })
            .then(async response => {
                if(!response.ok) {
                    let a = await response.json();
                    Errors.innerHTML = a.error;
                }
                else
                    return response.json();
            })
            .then(data => {
                ID.value = "";
                Name.value = "";
                Bday.value = "";
            })
    };
    const remove = () => {
        Errors.innerHTML = "";
        fetch("/api/db", {
            method: "DELETE",
            headers: {'Accept': 'application/json', 'Content-Type': 'application/json',},
            body: JSON.stringify({
                id: ID.value,
                name: Name.value,
                bday: Bday.value,
            })
        })
            .then(async response => {
                if (!response.ok) {
                    let a = await response.json();
                    Errors.innerHTML = a.error;
                } else
                    return response.json();
            })
            .then(data => {
                ID.value = "";
                Name.value = "";
                Bday.value = "";
            })
    };

</script>
</body>
</html>